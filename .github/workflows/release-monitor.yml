name: Monitor Repositories Release Updates

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0,12 * * *"
  workflow_dispatch:

jobs:
  check-releases:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Load versions
        id: load_versions
        run: |
          mkdir -p data
          if [ ! -f data/release_versions.json ]; then
            echo "{}" > data/release_versions.json
          fi
          echo "versions=$(jq -c . data/release_versions.json)" >> $GITHUB_OUTPUT

      - name: Check releases
        id: check
        run: |
          VERSIONS='${{ steps.load_versions.outputs.versions }}'
          echo "$VERSIONS" > versions.json

          UPDATED=false
          UPDATE_MSG=""

          # ===== ä»“åº“åˆ—è¡¨ =====
          REPOS=(
            "OpenListTeam/OpenList"
            "dani-garcia/vaultwarden"
            "bitwarden/android"
            "cloudflare/cloudflared"
            "n8n-io/n8n"
          )
          # ===================

          for REPO in "${REPOS[@]}"; do
            echo "Checking $REPO ..."

            API="https://api.github.com/repos/$REPO/releases/latest"
            TAG=$(curl -s $API | jq -r '.tag_name')

            if [ "$TAG" = "null" ]; then
              echo "No release found for $REPO"
              continue
            fi

            STORED=$(jq -r --arg REPO "$REPO" '.[$REPO]' versions.json)

            # åˆæ¬¡è¿è¡Œï¼Œä»…è®°å½•ä¸è§†ä¸ºæ›´æ–°
            if [ "$STORED" = "null" ]; then
              jq --arg REPO "$REPO" --arg TAG "$TAG" '.[$REPO] = $TAG' versions.json > tmp.json
              mv tmp.json versions.json
              echo "First record for $REPO"
              continue
            fi

            # æ£€æµ‹æ›´æ–°
            if [ "$STORED" != "$TAG" ]; then
              UPDATED=true
              UPDATE_MSG+="\nðŸ”„ $REPO æ›´æ–°ï¼š*$STORED* â†’ *$TAG*"

              jq --arg REPO "$REPO" --arg TAG "$TAG" '.[$REPO] = $TAG' versions.json > tmp.json
              mv tmp.json versions.json
            fi
          done

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "update_msg=$UPDATE_MSG" >> $GITHUB_OUTPUT

      - name: Save version file
        run: |
          cp versions.json data/release_versions.json

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/release_versions.json
          git commit -m "Update release versions" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: Send PushPlus (only if updated)
        if: steps.check.outputs.updated == 'true'
        run: |
          TOKEN=${{ secrets.PUSHPLUS_TOKEN }}
          MESSAGE="${{ steps.check.outputs.update_msg }}"

          curl -X POST -H "Content-Type: application/json" \
            -d "{\"token\":\"$TOKEN\",\"title\":\"GitHub Release æ›´æ–°\",\"content\":\"$MESSAGE\"}" \
            https://www.pushplus.plus/send
