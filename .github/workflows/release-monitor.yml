name: Monitor Repositories Release Updates

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0,12 * * *"
  workflow_dispatch:

jobs:
  check-releases:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install GNU Parallel
        run: sudo apt-get update && sudo apt-get install -y parallel

      - name: Ensure directories
        run: |
          mkdir -p data/versions
          mkdir -p tmp_msgs # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºå­˜æ”¾å¹¶å‘ä»»åŠ¡çš„æ—¥å¿—

      - name: Check releases (Parallel)
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # === 1. å‡†å¤‡å·¥ä½œ ===
          CONFIG_FILE="repos.txt"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ Error: $CONFIG_FILE not found!"
            exit 1
          fi

          # === 2. å®šä¹‰æ ¸å¿ƒæ£€æŸ¥å‡½æ•° (å°†è¢«å¹¶å‘è°ƒç”¨) ===
          # æ³¨æ„ï¼šBash å‡½æ•°å†…éƒ¨æ— æ³•ç›´æ¥ä¿®æ”¹çˆ¶è¿›ç¨‹å˜é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠæ›´æ–°æ¶ˆæ¯å†™å…¥ tmp_msgs ç›®å½•
          check_repo_func() {
            repo=$(echo "$1" | xargs) # å»é™¤ç©ºæ ¼
            [ -z "$repo" ] && return  # ç©ºè¡Œè·³è¿‡

            # å®šä¹‰æ–‡ä»¶è·¯å¾„
            file_path="data/versions/${repo//\//_}.txt"
            # ä¸´æ—¶æ¶ˆæ¯æ–‡ä»¶ï¼Œä½¿ç”¨ base64 ç¼–ç æ–‡ä»¶åé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
            msg_file="tmp_msgs/$(echo "$repo" | base64).msg"

            # è¯·æ±‚ API
            api_url="https://api.github.com/repos/$repo/releases/latest"
            # å¢åŠ  --fail é¿å… 404 äº§ç”Ÿé”™è¯¯è¾“å‡ºï¼Œå¢åŠ  --max-time é˜²æ­¢å¡æ­»
            tag=$(curl -s --fail --max-time 10 -H "Authorization: Bearer $GH_TOKEN" "$api_url" | jq -r '.tag_name')

            if [ "$tag" = "null" ] || [ -z "$tag" ]; then
              echo "âš ï¸ No release/error for $repo"
              return
            fi

            # A. åˆæ¬¡è®°å½•
            if [ ! -f "$file_path" ]; then
              echo "$tag" > "$file_path"
              echo "âœ… Initial: $repo -> $tag"
              echo "ğŸ“¦ $repoï¼šåˆæ¬¡è®°å½• <b>$tag</b>" > "$msg_file"
              return
            fi

            # B. æ£€æŸ¥æ›´æ–°
            stored=$(cat "$file_path")
            if [ "$stored" != "$tag" ]; then
              echo "$tag" > "$file_path"
              echo "ğŸ”„ Updated: $repo ($stored -> $tag)"
              echo "ğŸ”„ $repoï¼š$stored â†’ <b>$tag</b>" > "$msg_file"
            else
              echo "â¹ï¸ No change: $repo"
            fi
          }
          
          # å¯¼å‡ºå‡½æ•°å’Œå˜é‡ä¾› parallel ä½¿ç”¨
          export -f check_repo_func
          export GH_TOKEN

          # === 3. å¹¶å‘æ‰§è¡Œ ===
          echo "ğŸš€ Starting parallel checks..."
          # -j 10: åŒæ—¶è¿è¡Œ 10 ä¸ªä»»åŠ¡
          # --bar: æ˜¾ç¤ºè¿›åº¦æ¡
          cat "$CONFIG_FILE" | tr -d '\r' | grep -vE '^\s*#|^\s*$' | parallel -j 10 --bar check_repo_func {}

          # === 4. æ±‡æ€»ç»“æœ ===
          # æ£€æŸ¥ tmp_msgs ç›®å½•ä¸‹æ˜¯å¦æœ‰æ–‡ä»¶ï¼Œæœ‰è¯´æ˜æœ‰æ›´æ–°
          if [ "$(ls -A tmp_msgs)" ]; then
            UPDATED=true
            # å°†æ‰€æœ‰æ¶ˆæ¯æ–‡ä»¶åˆå¹¶ï¼Œå¹¶æ·»åŠ æ¢è¡Œç¬¦
            UPDATE_MSG=$(cat tmp_msgs/*.msg | awk '{print $0"\\n"}')
            echo "Updates detected."
          else
            UPDATED=false
            UPDATE_MSG=""
            echo "No updates detected."
          fi

          # === 5. è¾“å‡ºåˆ° GitHub Actions ===
          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          
          DELIMITER=$(openssl rand -hex 8)
          {
            echo "update_msg<<$DELIMITER"
            echo -e "$UPDATE_MSG"
            echo "$DELIMITER"
          } >> $GITHUB_OUTPUT

      - name: Commit version files
        if: steps.check.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/versions
          git diff-index --quiet HEAD || git commit -m "chore: update release versions (auto)"
          git push

      - name: Send PushPlus Notification
        if: steps.check.outputs.updated == 'true'
        env:
          TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          MSG: ${{ steps.check.outputs.update_msg }}
        run: |
          # æ„å»º JSON
          PAYLOAD=$(jq -n \
            --arg token "$TOKEN" \
            --arg title "GitHub Release æ›´æ–°" \
            --arg content "$MSG" \
            --arg template "html" \
            '{token: $token, title: $title, content: $content, template: $template}')

          curl -X POST -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            https://www.pushplus.plus/send
