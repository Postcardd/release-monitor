name: Monitor Repositories Release Updates

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0,12 * * *"
  workflow_dispatch:

jobs:
  check-releases:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure version directory
        run: |
          mkdir -p data/versions

      - name: Check releases
        id: check
        run: |
          UPDATED=false
          UPDATE_MSG=""

          REPOS=(
            "OpenListTeam/OpenList"
            "dani-garcia/vaultwarden"
            "bitwarden/android"
            "cloudflare/cloudflared"
            "n8n-io/n8n"
          )

          for REPO in "${REPOS[@]}"; do
            FILE="data/versions/${REPO//\//_}.txt"

            API="https://api.github.com/repos/$REPO/releases/latest"
            TAG=$(curl -s "$API" | jq -r '.tag_name')

            if [ "$TAG" = "null" ] || [ -z "$TAG" ]; then
              echo "No release for $REPO"
              continue
            fi

            # å¦‚æžœæ–‡ä»¶ä¸å­˜åœ¨ â†’ åˆ›å»ºå¹¶æ ‡è®°ä¸ºæ›´æ–°
            if [ ! -f "$FILE" ]; then
              echo "$TAG" > "$FILE"
              echo "Initial version recorded for $REPO: $TAG"
              UPDATED=true
              UPDATE_MSG+="\nðŸ“¦ $REPOï¼šåˆæ¬¡è®°å½• *$TAG*"
              continue
            fi

            STORED=$(cat "$FILE")

            if [ "$STORED" != "$TAG" ]; then
              echo "$TAG" > "$FILE"
              UPDATED=true
              UPDATE_MSG+="\nðŸ”„ $REPOï¼š*$STORED* â†’ *$TAG*"
            fi
          done

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "update_msg=$UPDATE_MSG" >> $GITHUB_OUTPUT

      - name: Commit version files
        if: steps.check.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/versions
          git commit -m "Initial or updated release versions"
          git push

      - name: Send PushPlus Notification
        if: steps.check.outputs.updated == 'true'
        run: |
          TOKEN=${{ secrets.PUSHPLUS_TOKEN }}
          MSG="${{ steps.check.outputs.update_msg }}"

          curl -X POST -H "Content-Type: application/json" \
            -d "{\"token\":\"$TOKEN\",\"title\":\"GitHub Release æ›´æ–°\",\"content\":\"$MSG\"}" \
            https://www.pushplus.plus/send
